// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  // Use native Node.js addon instead of standalone binary engine to reduce deployment size
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model (for NextAuth.js)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  role          String    @default("member") // member, admin
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // NextAuth.js relations
  accounts      Account[]
  sessions      Session[]
  
  // Relations
  auditLogs     AuditLog[]
  player        Player?

  @@index([email])
}

// NextAuth.js Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth.js Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth.js VerificationToken model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Player model
model Player {
  id        String   @id @default(cuid())
  name      String
  nickname  String   @unique
  country   String?
  password  String?  // bcrypt hashed password for player authentication
  deletedAt DateTime? // ソフトデリート用タイムスタンプ
  version   Int      @default(0) // 楽観的ロック用
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation (Optional, for linked users)
  userId    String?  @unique
  user      User?    @relation(fields: [userId], references: [id])

  // Battle Mode relations
  bmPlayer1Matches BMMatch[] @relation("BMPlayer1")
  bmPlayer2Matches BMMatch[] @relation("BMPlayer2")
  bmQualifications BMQualification[]

  // Match Race relations
  mrPlayer1Matches MRMatch[] @relation("MRPlayer1")
  mrPlayer2Matches MRMatch[] @relation("MRPlayer2")
  mrQualifications MRQualification[]

  // Grand Prix relations
  gpPlayer1Matches GPMatch[] @relation("GPPlayer1")
  gpPlayer2Matches GPMatch[] @relation("GPPlayer2")
  gpQualifications GPQualification[]

  // Time Trial relations
  ttEntries TTEntry[]

  // Score entry logs (all match types)
  scoreEntryLogs ScoreEntryLog[]

  // Character usage tracking
  characterUsages MatchCharacterUsage[]

  // Tournament scores (aggregated points)
  tournamentScores TournamentPlayerScore[]
}

// Tournament model
model Tournament {
  id            String   @id @default(cuid())
  name          String
  date          DateTime
  status        String   @default("draft") // draft, active, completed
  frozenStages  Json     @default("[]") // 凍結されたTAステージ名の配列 (例: ["qualification", "phase1"])
  deletedAt     DateTime? // ソフトデリート用タイムスタンプ
  version       Int      @default(0) // 楽観的ロック用
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Related data
  bmMatches        BMMatch[]
  bmQualifications BMQualification[]
  mrMatches        MRMatch[]
  mrQualifications MRQualification[]
  gpMatches        GPMatch[]
  gpQualifications GPQualification[]
  ttEntries        TTEntry[]
  ttPhaseRounds    TTPhaseRound[]
  playerScores     TournamentPlayerScore[]
}

// Course model (for Time Trial and Match Race)
model Course {
  id   String @id @default(cuid())
  name String
  abbr String @unique // MC1, DP1, GV1, etc.
  cup  String // Mushroom, Flower, Star, Special
}

// Battle Arena model
model Arena {
  id   String @id @default(cuid())
  name String
  abbr String @unique // Arena 1-4
}

// ==========================================
// Battle Mode Models
// ==========================================

model BMQualification {
  id           String     @id @default(cuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  player       Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId     String
  group        String // A, B, C
  seeding      Int?
  mp           Int        @default(0) // Matches Played
  wins         Int        @default(0)
  ties         Int        @default(0)
  losses       Int        @default(0)
  winRounds    Int        @default(0)
  lossRounds   Int        @default(0)
  points       Int        @default(0) // Calculated: winRounds - lossRounds
  score        Int        @default(0) // Ranking score
  deletedAt    DateTime?  // ソフトデリート用タイムスタンプ
  version      Int        @default(0) // 楽観的ロック用

  @@unique([tournamentId, playerId])
}

model BMMatch {
  id           String     @id @default(cuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  matchNumber  Int
  stage        String     @default("qualification") // qualification, finals, grand_final
  round        String? // For finals: "wb-r1", "wb-r2", "wb-semi", "wb-final", "lb-r1", "lb-r2", etc.
  tvNumber     Int?
  player1      Player     @relation("BMPlayer1", fields: [player1Id], references: [id])
  player1Id    String
  player1Side  Int        @default(1) // 1 or 2 (which controller)
  player2      Player     @relation("BMPlayer2", fields: [player2Id], references: [id])
  player2Id    String
  player2Side  Int        @default(2)
  score1       Int        @default(0) // Player 1's wins (e.g., 4 in "4-0")
  score2       Int        @default(0) // Player 2's wins
  completed    Boolean    @default(false)
  rounds       Json? // [{arena: "Arena 1", winner: 1}, ...]

  // Double elimination fields
  bracket      String?     // "winners", "losers", "grand_final"
  bracketPosition String? // "wb-r1", "wb-r2", "wb-semi", "wb-final", "lb-r1", "lb-r2"
  losses       Int        @default(0) // Losses in this stage
  isGrandFinal Boolean    @default(false)

  // Player-reported scores (for participant score entry)
  player1ReportedScore1 Int? // Player 1's report: score for player 1
  player1ReportedScore2 Int? // Player 1's report: score for player 2
  player2ReportedScore1 Int? // Player 2's report: score for player 1
  player2ReportedScore2 Int? // Player 2's report: score for player 2

  deletedAt    DateTime?  // ソフトデリート用タイムスタンプ
  version      Int        @default(0) // 楽観的ロック用
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([tournamentId, matchNumber, stage])
}

// ==========================================
// Match Race Models
// ==========================================

model MRQualification {
  id           String     @id @default(cuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  player       Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId     String
  group        String
  seeding      Int?
  mp           Int        @default(0)
  wins         Int        @default(0)
  ties         Int        @default(0)
  losses       Int        @default(0)
  winRounds    Int        @default(0)
  lossRounds   Int        @default(0)
  points       Int        @default(0)
  score        Int        @default(0)
  deletedAt    DateTime?  // ソフトデリート用タイムスタンプ
  version      Int        @default(0) // 楽観的ロック用

  @@unique([tournamentId, playerId])
}

model MRMatch {
  id           String     @id @default(cuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  matchNumber  Int
  stage        String     @default("qualification") // qualification, finals, grand_final
  round        String? // For finals: "wb-r1", "wb-r2", "wb-semi", "wb-final", "lb-r1", "lb-r2", etc.
  tvNumber     Int?
  player1      Player     @relation("MRPlayer1", fields: [player1Id], references: [id])
  player1Id    String
  player1Side  Int        @default(1) // 1 or 2 (which controller)
  player2      Player     @relation("MRPlayer2", fields: [player2Id], references: [id])
  player2Id    String
  player2Side  Int        @default(2)
  score1       Int        @default(0)
  score2       Int        @default(0)
  completed    Boolean    @default(false)
  rounds       Json? // [{course: "MC1", winner: 1}, ...]

  // Double elimination fields
  bracket      String?     // "winners", "losers", "grand_final"
  bracketPosition String? // "wb-r1", "wb-r2", "wb-semi", "wb-final", "lb-r1", "lb-r2"
  losses       Int        @default(0) // Losses in this stage
  isGrandFinal Boolean    @default(false)

  // Player-reported scores
  player1ReportedPoints1 Int? // Player 1's report: points for player 1
  player1ReportedPoints2 Int? // Player 1's report: points for player 2
  player1ReportedRaces Json? // Player 1's report: races details
  player2ReportedPoints1 Int? // Player 2's report: points for player 1
  player2ReportedPoints2 Int? // Player 2's report: points for player 2
  player2ReportedRaces Json? // Player 2's report: races details

  deletedAt    DateTime?  // ソフトデリート用タイムスタンプ
  version      Int        @default(0) // 楽観的ロック用
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([tournamentId, matchNumber, stage])
}

// ==========================================
// Grand Prix Models
// ==========================================

model GPQualification {
  id           String     @id @default(cuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  player       Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId     String
  group        String
  seeding      Int?
  mp           Int        @default(0)
  wins         Int        @default(0)
  ties         Int        @default(0)
  losses       Int        @default(0)
  points       Int        @default(0) // Driver points total
  score        Int        @default(0)
  deletedAt    DateTime?  // ソフトデリート用タイムスタンプ
  version      Int        @default(0) // 楽観的ロック用

  @@unique([tournamentId, playerId])
}

model GPMatch {
  id           String     @id @default(cuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  matchNumber  Int
  stage        String     @default("qualification")
  round        String?
  cup          String? // Mushroom, Flower, Star, Special
  tvNumber     Int?
  player1      Player     @relation("GPPlayer1", fields: [player1Id], references: [id])
  player1Id    String
  player1Side  Int        @default(1)
  player2      Player     @relation("GPPlayer2", fields: [player2Id], references: [id])
  player2Id    String
  player2Side  Int        @default(2)
  points1      Int        @default(0) // Driver points for player 1
  points2      Int        @default(0) // Driver points for player 2
  completed    Boolean    @default(false)
  races        Json? // [{course: "MC1", position1: 1, position2: 2, points1: 9, points2: 6}, ...]

  // Player-reported scores (for participant score entry)
  player1ReportedPoints1 Int? // Player 1's report: points for player 1
  player1ReportedPoints2 Int? // Player 1's report: points for player 2
  player1ReportedRaces Json? // Player 1's report: races details
  player2ReportedPoints1 Int? // Player 2's report: points for player 1
  player2ReportedPoints2 Int? // Player 2's report: points for player 2
  player2ReportedRaces Json? // Player 2's report: races details

  deletedAt    DateTime?  // ソフトデリート用タイムスタンプ
  version      Int        @default(0) // 楽観的ロック用
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([tournamentId, matchNumber, stage])
}

// ==========================================
// Time Trial Models
// ==========================================

// Audit Log model
model AuditLog {
  id          String   @id @default(cuid())
  userId      String?  // User ID (null for anonymous actions)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  ipAddress   String
  userAgent   String
  action      String   // CREATE_TOURNAMENT, UPDATE_MATCH, etc.
  targetId    String?  // Target resource ID
  targetType  String?  // Target resource type: Tournament, Player, Match, etc.
  timestamp   DateTime @default(now())
  details     Json?    // Additional details

  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([targetType, targetId])
}

// Score Entry Log model - Tracks participant score submissions
model ScoreEntryLog {
  id           String   @id @default(cuid())
  tournamentId  String
  matchId      String
  matchType    String   // BM, MR, GP
  playerId     String
  player       Player   @relation(fields: [playerId], references: [id])

  // Reported data (varies by match type)
  reportedData Json     // Flexible storage for different match types

  // Metadata
  ipAddress     String
  userAgent     String
  timestamp     DateTime @default(now())

  @@index([matchId])
  @@index([playerId])
  @@index([timestamp])
  @@index([tournamentId])
}

// Match Character Usage model - Tracks which characters players use in matches
model MatchCharacterUsage {
  id          String   @id @default(cuid())
  matchId     String
  matchType   String   // BM, MR, GP
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id])

  // Character used
  character   String   // Mario, Luigi, Peach, Toad, Yoshi, DK Jr., Bowser, Koopa

  // Metadata
  createdAt   DateTime @default(now())

  @@unique([matchId, matchType, playerId])
  @@index([playerId])
  @@index([character])
}

// ==========================================
// Time Trial Models
// ==========================================

// TTPhaseRound - Tracks each round played within a finals phase.
// Stores the randomly selected course, all player results, and elimination outcomes.
// Used for:
// - Random course selection (no repeat until all 20 used per phase)
// - Round-by-round history display
// - Elimination and life-reset tracking
model TTPhaseRound {
  id              String     @id @default(cuid())
  tournament      Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId    String
  phase           String     // "phase1", "phase2", "phase3"
  roundNumber     Int        // Sequential round number within the phase
  course          String     // Course abbreviation (e.g., "MC1")
  results         Json       // Array: [{playerId, timeMs, isRetry}]
  eliminatedIds   Json?      // Array of player IDs eliminated this round
  livesReset      Boolean    @default(false) // Whether lives were reset after this round
  createdAt       DateTime   @default(now())

  @@unique([tournamentId, phase, roundNumber])
  @@index([tournamentId, phase])
}

model TTEntry {
  id           String     @id @default(cuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  player       Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId     String
  stage        String     @default("qualification") // qualification, phase1, phase2, phase3
  lives        Int        @default(3) // For phase3 finals
  eliminated   Boolean    @default(false)
  times        Json? // {"MC1": "1:23.45", "DP1": "1:12.34", ...}
  totalTime    Int? // Total time in milliseconds
  rank         Int?
  courseScores         Json?   // Points per course: {"MC1": 45, "DP1": 50, ...}
  qualificationPoints  Int?    // Total qualification points (max 1000)
  deletedAt    DateTime?  // ソフトデリート用タイムスタンプ
  version      Int        @default(0) // 楽観的ロック用
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([tournamentId, playerId, stage])
}

// ==========================================
// Tournament Points System
// ==========================================

// Aggregated tournament points for each player across all 4 modes
model TournamentPlayerScore {
  id              String     @id @default(cuid())
  tournament      Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId    String
  player          Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId        String

  // Qualification points (each mode max 1000)
  taQualificationPoints  Int @default(0)
  bmQualificationPoints  Int @default(0)
  mrQualificationPoints  Int @default(0)
  gpQualificationPoints  Int @default(0)

  // Finals points (each mode max 2000)
  taFinalsPoints  Int @default(0)
  bmFinalsPoints  Int @default(0)
  mrFinalsPoints  Int @default(0)
  gpFinalsPoints  Int @default(0)

  // Total and ranking
  totalPoints     Int @default(0)  // Max 12000 (4 modes × 3000 max each)
  overallRank     Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tournamentId, playerId])
  @@index([tournamentId])
  @@index([totalPoints])
}
