# JSMKC コードレビュードキュメント

レビュー日: 2026-01-19
レビュアー: レビューエージェント

---

## 概要

ARCHITECTURE.md と IMPLEMENTED.md をレビューしました。IMPLEMENTED.md の修正内容は適切ですが、アーキテクチャ設計に複数の重大な問題が見つかりました。

**判定: 問題あり - 実装エージェントへのフィードバックが必要**

---

## 重大な問題

### 1. JWTトークンのRefreshトークン機構が未設計

**ファイル**: docs/ARCHITECTURE.md:83

**内容**:
```
セッション管理: JWT、有効期限24時間
```

**問題点**:
- 24時間の有効期限のみ記載、Refreshトークン機構が言及されていない
-  длительные大会（数時間に及ぶ）でユーザーセッションが切れる可能性
- NextAuth.js v5ではRefresh Tokenが標準機能として存在するが、設計書に記載なし

**影響**:
- 運営ユーザーが大会中にログアウトされるリスク
- ユーザー体験の低下

**推奨対応**:
- Refresh Token機構の設計を追加
- または、24時間有効期限が十分な根拠を明記

---

### 2. Soft Delete未実装 - AuditLogの追跡が不完全

**ファイル**: docs/ARCHITECTURE.md:264-275, 278-286

**内容**:
AuditLogモデルには `userId Int?` が定義されているが、Player/TournamentのDelete時に：
- 削除されたことが記録されない
- 削除されたデータの復元手段がない

**問題点**:
- 「プレイヤー作成/編集/削除」が履歴管理の対象（279-280行目）と記載されているが、Delete操作の追跡方法が決まっていない
- Hard Deleteの場合、AuditLogに記録しても対象データ参照不能

**影響**:
- 削除履歴の追跡が不十分
- 誤削除時の復元が困難

**推奨対応**:
- Soft Delete（isDeletedフラグ）の導入を検討
- または、Delete前にデータをAuditLogに完全バックアップする設計

---

### 3. AuditLog.details (Json) のXSS脆弱性リスク

**ファイル**: docs/ARCHITECTURE.md:273

**内容**:
```prisma
details     Json?    // 追加の詳細情報
```

**問題点**:
- ユーザー入力をJson形式で保存する場合、適切なサニタイゼーションなし
- 詳細情報を表示するUIでXSS攻撃が可能

**影響**:
- 管理画面でのXSS脆弱性
- セッションハイジャックリスク

**推奨対応**:
- details保存時にサニタイゼーション（strip-tags相当）を実装
- 表示時にHTMLエスケープ処理を追加

---

## 中程度の問題

### 4. CSPヘッダーの実装詳細が不明

**ファイル**: docs/ARCHITECTURE.md:105-106

**内容**:
```
CSPヘッダー: 外部スクリプトの制限（XSS対策）
```

**問題点**:
- CSPポリシーの具体的な設定が記載されていない
- shadcn/ui や Radix UI に必要なstyle-src、script-srcの記載なし
- 本番環境でのnonce使用が言及されているが、実装詳細なし

**影響**:
- セキュリティヘッダーの実装が曖昧
- 開発時の追加作業発生

**推奨対応**:
- 具体的なCSPポリシーを設計書に追加
- Next.jsでのnonce実装方法を明記

---

### 5. ポーリング頻度の負荷検証不足

**ファイル**: docs/ARCHITECTURE.md:192, 462

**内容**:
```
リアルタイム更新: Polling（3秒間隔）
```

**計算（462行目）**:
- 48人 × (60秒/3秒) = 960回/時間 × 24時間 × 2日大会 = 46,080回

**問題点**:
- 46,080回のAPI呼び出しがVercelのServerless Function制限内か検証不足
- 各リクエストの実際の処理時間（DB接続含む）が100msで計算されているが、実測値との差異の可能性
- 48人全員が同時にポーリングした場合のスパイク負荷 고려不足

**影響**:
- 大会中の応答遅延
- Vercelリソース超過によるエラー

**推奨対応**:
- 負荷テストの実施と設計への反映
- ポーリング間隔の調整（3秒→5秒以上）を検討

---

### 6. 同時編集の競合処理が不明

**ファイル**: docs/ARCHITECTURE.md:60

**内容**:
```
同時編集時の競合処理
```

**問題点**:
- 設計書で言及されているが、具体的な実装方法（Optimistic Locking、Last Write Wins等）が不明
- 参加者スコア入力での競合発生時の挙動が未定義

**影響**:
- スコアの上書きが発生する可能性
- データの整合性リスク

**推奨対応**:
- 競合処理ポリシーを明確に定義
- 楽観的ロック（versionフィールド）の導入を検討

---

## 軽微な問題

### 7. レート制限の閾値根拠不足

**ファイル**: docs/ARCHITECTURE.md:95

**内容**:
```
レート制限: 1IPあたり10回/分（Redis/Vercel KV）
```

**問題点**:
- 10回/分の根拠が記載されていない
- 正常な操作（スコア入力、更新ポーリング）で制限に抵触する可能性

**推奨対応**:
- 閾値決定の根拠を明記
- エンドポイントごとの柔軟な制限設定を検討

---

### 8. トークン延長機能の実装詳細不明

**ファイル**: docs/ARCHITECTURE.md:90

**内容**:
```
有効期限: 24時間（大会期間中は延長可能）
```

**問題点**:
- 「延長可能」と記載されているが、実装方法（手動/自動、権限者など）が不明

**推奨対応**:
- 延長機能の実装詳細を追加

---

## 実装エージェントへの修正依頼事項

上記の重大問題および中程度の問題について、ARCHITECTURE.md の修正をお願いします。特に：

1. **JWT Refresh Token機構の設計追加**
2. **Soft DeleteまたはDelete前バックアップの設計**
3. **AuditLog.detailsのXSS対策設計**
4. **CSPポリシーの具体化**
5. **ポーリング負荷の検証結果反映**
6. **同時編集競合処理の明確化**

---

## 実装エージェントへのフィードバック

以下のコマンドで実装エージェントにフィードバックを送信してください：

```
zellij action write-chars "/clear" && zellij action write 13 && zellij action write-chars "/f-implement" && zellij action write 32 && zellij action write-chars "レビューエージェントです。ARCHITECTURE.mdに重大な問題が発見されました。REVIEW.mdを確認し、8項目の問題を修正してください。特にJWT Refresh Token、Soft Delete、XSS対策、CSP詳細、ポーリング負荷、競合処理の設計を追加・明確化してください。" && sleep 3 && zellij action write 13
```
