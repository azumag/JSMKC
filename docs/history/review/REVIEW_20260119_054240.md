# コードレビューレポート

**Date**: 2026-01-19
**Reviewer**: Code Review Agent
**対象**: docs/IMPLEMENTED.md および実装コード

---

## 総合評価

**判定**: ⚠️ **重大な問題あり - 修正が必要**

実装はArchitecture.mdの仕様を概ね満たしているが、重大なバグと設計上の問題が発見された。これらの問題を修正しない場合、本番環境でセキュリティリスクや機能障害が発生する可能性がある。

**発見された問題数**:
- 重大問題: 3件
- 主要問題: 5件  
- 軽微問題: 4件

---

## 重大問題（3件）

### CR-001: GitHub OAuthでRefresh Tokenが機能しない

**場所**: `jsmkc-app/src/lib/auth.ts:187-195`

**問題**: JWT callbackでGitHub OAuthプロバイダーのrefresh token処理が欠落している。GoogleプロバイダーにはrefreshAccessTokenの呼び出しがあるが、GitHubプロバイダーにはこのロジックがない。

```typescript
// 現在の実装（問題あり）
if (account?.provider === 'google' && token.refreshToken) {
  return refreshAccessToken(token)
}
// GitHubプロバイダーのrefresh token処理がない ❌
```

**影響**: GitHubでログインしたユーザーは、1時間後に再度ログインが必要となる。Architecture.mdで指定された24時間のrefresh tokenが機能しない。

**修正案**:
```typescript
// 修正案
if (token.refreshToken) {
  return refreshAccessToken(token)
}
```

**根拠**: Refresh Tokenはプロバイダーに関係なく機能するはず。GoogleとGitHubの両方でOAuth refresh flowは似ている。

---

### CR-002: メモリリークの可能性（in-memory rate limiting）

**場所**: `jsmkc-app/src/lib/rate-limit.ts:108`

**問題**: in-memory rate limitingのstore（Map）へのアイテム削除が`rateLimitInMemory`関数内でのみ行われ、cleanupが不完全。長時間の運用でメモリ使用量が増加する可能性がある。

```typescript
const rateLimitStore = new Map<string, { count: number; resetTime: number }>();

function rateLimitInMemory(...) {
  // 各リクエストでクリーンアップを試みるが、
  // アイテムが完全にクリーンアップされない場合がある
  for (const [key, value] of rateLimitStore.entries()) {
    if (value.resetTime < now) {
      rateLimitStore.delete(key);
    }
  }
}
```

**影響**: 長時間運用でメモリ使用量が増加し、最終的にサーバークラッシュの可能性。

**修正案**:
```typescript
// 定期的なクリーンアップ_INTERVALを設定
const CLEANUP_INTERVAL = 60 * 1000; // 1分ごと
let lastCleanup = 0;

function rateLimitInMemory(identifier, limit, windowMs) {
  const now = Date.now();
  
  // 定期的なクリーンアップ
  if (now - lastCleanup > CLEANUP_INTERVAL) {
    lastCleanup = now;
    for (const [key, value] of rateLimitStore.entries()) {
      if (value.resetTime < now) {
        rateLimitStore.delete(key);
      }
    }
  }
  // ... rest of implementation
}
```

---

### CR-003: レイアウトでのnonce伝播が不十分

**場所**: `jsmkc-app/src/middleware.ts` および `layout.tsx`

**問題**: ミドルウェアでnonceを生成し`x-nonce`ヘッダーに設定しているが、layout.tsxでクライアントサイドのスクリプトに対してこのnonceを使用していない。Architecture.mdで指定された「nonce使用」が不完全。

```typescript
// middleware.tsでは設定されている ✅
requestHeaders.set('x-nonce', nonce)

// layout.tsxでスクリプトに使用されていない ❌
// <Script src="..." /> にnonce={nonce}がない
```

**影響**: 一部のクライアントサイドスクリプトがCSPに違反する可能性、またはCSPが過度に緩くなる可能性。

**修正案**: layout.tsxでnonceを取得し、すべてのスクリプトタグに設定する。

```typescript
// layout.tsxでの例
import { headers } from 'next/headers'

export default function RootLayout({ children }) {
  const headersList = headers()
  const nonce = headersList.get('x-nonce') || ''
  
  return (
    <html>
      <Script 
        src="..." 
        nonce={nonce}
        strategy="afterInteractive"
      />
    </html>
  )
}
```

---

## 主要問題（5件）

### MJ-001: エラーレスポンス形式が統一されていない

**場所**: 複数のAPIルート

**問題**: 一部のAPIは`{ success: false, error: "..." }`を返し、別のAPIは`{ error: "..." }`を返している。

```typescript
// 返り値の形式が混在 ❌
// route.ts A
return NextResponse.json(
  { success: false, error: "Match not found" }, 
  { status: 404 }
)

// route.ts B  
return NextResponse.json(
  { error: "Match not found" },
  { status: 404 }
)
```

**影響**: フロントエンドでのエラー処理が複雑化。一貫したAPI設計原则に反する。

**修正案**: `ApiResponse`型を定義し、すべてのAPIで統一された形式を使用。

```typescript
// lib/api-types.ts
type ApiResponse<T = unknown> = {
  success: boolean;
  data?: T;
  error?: string;
}

// すべてのAPIで { success: boolean, error?: string } 形式を使用
```

---

### MJ-002: Zodがインストールされているが使用されていない

**問題**: package.jsonにZodが含まれているが、実際のAPI入力バリデーションで使用されていない。Architecture.mdで「Zodによるサーバーサイドバリデーション」と指定されている。

**影響**: 入力検証が不十分で、不正なデータがデータベースに保存される可能性。

**修正案**: すべてのPOST/PUTリクエストでZodスキーマによるバリデーションを追加。

```typescript
// 例: report/route.ts
import { z } from 'zod'

const ReportScoreSchema = z.object({
  reportingPlayer: z.union([z.literal(1), z.literal(2)]),
  score1: z.number().min(0).max(3),
  score2: z.number().min(0).max(3),
})

export async function POST(request: NextRequest, ...) {
  const body = sanitizeInput(await request.json())
  const result = ReportScoreSchema.safeParse(body)
  
  if (!result.success) {
    return NextResponse.json(
      { success: false, error: 'Invalid input' },
      { status: 400 }
    )
  }
  // ...
}
```

---

### MJ-003: テストが実装されていない

**問題**: IMPLEMENTED.mdには「✅ テストカバレッジ追加」と記載されているが、実際にはテストファイルが存在しない。

**影響**: リグレッションの検出が困難。バグが発見しにくい環境。

**修正案**: VitestまたはJestを使用して基本的なテストを追加。

```typescript
// 例: tests/sanitize.test.ts
import { sanitizeString, sanitizeObject } from '@/lib/sanitize'
import { describe, it, expect } from 'vitest'

describe('sanitizeInput', () => {
  it('should sanitize XSS content', () => {
    expect(sanitizeString('<script>alert("xss")</script>')).toBe('')
  })
  
  it('should preserve safe HTML', () => {
    expect(sanitizeString('<b>Hello</b>')).toBe('<b>Hello</b>')
  })
})
```

---

### MJ-004: アーキテクチャドキュメントのJWT設定と実際の実装の不整合

**問題**: Architecture.md section 6.2では`AUTH_GOOGLE_ID`と`AUTH_GOOGLE_SECRET`を使用すると記載されているが、実際のauth.tsでは`GITHUB_CLIENT_ID`/`GITHUB_CLIENT_SECRET`と`AUTH_GOOGLE_ID`/`AUTH_GOOGLE_SECRET`の両方が混在している。

**影響**: 設定の混乱。ドキュメントと実装の不一致による運用上の問題。

**修正案**: 環境変数名を統一し、ドキュメントを更新。

```typescript
// 推奨: 接頭辞を統一
AUTH_GOOGLE_ID / AUTH_GOOGLE_SECRET
AUTH_GITHUB_ID / AUTH_GITHUB_SECRET
```

---

### MJ-005: Audit Logの詳細ログ記録が非同期で失敗しても気づかない

**場所**: `jsmkc-app/src/lib/audit-log.ts` および全APIルート

**問題**: Audit Logの作成が非同期で行われ、失敗しても пользователь（ユーザー）に通知されない。重大な操作の監査が欠落する可能性がある。

```typescript
// 現在の実装
try {
  await createAuditLog(...)
} catch (logError) {
  console.error('Failed to create audit log:', logError)
  // エラーは無視される ❌
}
```

**影響**: セキュリティ監査の完全性が損なわれる。

**修正案**: 重要な操作ではaudit logの失敗をユーザーに通知するか、別のログシステムにフォールバック。

```typescript
// 修正案: 重要な操作ではaudit log失敗を考慮
async function createAuditLogWithFallback(data) {
  try {
    await createAuditLog(data)
  } catch (error) {
    // 代替ログシステムに送信
    console.error('Audit log failed, sent to alternative log:', error)
    // または、重要な操作の場合はエラーを投げる
    if (data.action === 'CRITICAL_ACTION') {
      throw error
    }
  }
}
```

---

## 軽微問題（4件）

### MN-001: 定数がハードコードされている

**問題**: マッチのポイント計算やスコア計算にハードコードされた数値が使用されている。

```typescript
// report/route.ts
if (score1 >= 3) {  // なぜ3？
  return { winner: 1, ... }
}
```

**修正案**: 定数ファイルに定義。

```typescript
// lib/constants.ts
export const BM_MATCH_POINT_THRESHOLD = 3
export const BM_TOTAL_ROUNDS = 4
```

---

### MN-002: エラーハンドリングの詳細が不十分

**問題**: エラーメッセージが具体的でない場合がある。

```typescript
catch (error) {
  console.error("Failed to report score:", error)
  return NextResponse.json(
    { error: "Failed to report score" },  // 具体的でない ❌
    { status: 500 }
  )
}
```

---

### MN-003: ドキュメントの欠如

**問題**: APIエンドポイントのドキュメントがない。OpenAPI/Swagger仕様がない。

---

### MN-004: セッション管理のorganization検証がGoogleにない

**問題**: GitHub OAuthでは`jsmkc-org`メンバーシップを検証しているが、Google OAuthではこの検証がない。

```typescript
// GitHub: organization検証あり ✅
// Google: organization検証なし ❌
```

---

## 実装状況の確認

###  Architecture.mdとの適合性

| 項目 | Architecture.md仕様 | 実装状況 | 判定 |
|------|---------------------|----------|------|
| JWT Refresh Token | 1時間アクセストークン、24時間refresh | 部分実装 | ⚠️ |
| XSS対策 | DOMPurifyサニタイズ | 実装済み | ✅ |
| ソフトデリート | deletedAtフィールド、ミドルウェア | 実装済み | ✅ |
| 楽観的ロック | versionフィールド、409 Conflict | 実装済み | ✅ |
| レート制限 | エンドポイント別設定 | 実装済み | ✅ |
| CSP | nonce使用 | 部分実装 | ⚠️ |
| テスト | 必須 | 未実装 | ❌ |

---

## 推奨修正優先順位

### 即座に修正（本番デプロイ前）

1. **CR-001**: GitHub OAuthのrefresh token処理を追加
2. **CR-002**: in-memory rate limitingのメモリリークを修正
3. **CR-003**: layout.tsxでのnonce伝播を実装

### 短期で修正（1週間以内）

4. **MJ-002**: Zodバリデーションを追加
5. **MJ-003**: 基本テストを追加

### 中期で修正（2週間以内）

6. **MJ-001**: エラーレスポンス形式を統一
7. **MJ-004**: 環境変数名を統一
8. **MJ-005**: Audit Logのフォールバック処理を実装
9. **MN-001**: 定数を別ファイルに分離

---

## 総括

実装はArchitecture.mdの基本要件を大部分満たしているが、以下の重大な問題が残されている：

1. **GitHub OAuthのrefresh token未実装** - ユーザー体験に大きな影響
2. **メモリリークの可能性** - 長時間運用の安定性リスク
3. **CSP nonceの不完全な伝播** - セキュリティリスク

これらの問題を修正した後、QAレビューに進むことを推奨する。

---

**Reviewer**: Code Review Agent
**Date**: 2026-01-19
**Status**: ⚠️ **修正が必要 - 再レビュー依頼可能**