# 新機能実装計画（GitHub Issues対応）

**Date**: 2026-01-19
**担当**: プロジェクトマネージャー

---

## GitHub Issues の分析

### 現状のIssues（5件）

1. **create new tornament で unauthorized になる**
   - 優先度: 中
   - トーナメント作成時に認証エラーが発生
   - 原因: トークン生成と認証ロジックの不一致

2. **[auth][error] MissingSecret**
   - 優先度: 高
   - 認因: AUTH_環境変数が未設定
   - 原因: GitHub OAuthアプリのClient Secret設定漏れ

3. **READMEを追加**
   - 優先度: 低
   - 認因: ドキュメントが整備されていない

4. **REDISはアーキテクチャに入っていないので入れないようにして**
   - 優先度: 中
   - 認因: Architecture.mdと実装の不一致
   - 原因: 開発環境と本番環境の違い

5. **REDISはアーキテクチャに入っていないので入れないようにして（重複）**
   - 優先度: 低
   - 認因: rate limiting実装の重複
   - 原因: GitHub Issue 4と重複

---

## 実装計画

### フェーズ1：調査と基本設定

#### 1.1 環境変数の確認と設定
- **AUTH_環境変数**（GitHub + Google）の必須項目を確認
- **NextAuth Secret**の設定
- **.env.example**に必要な変数を追記

#### 1.2 トークン生成と認証エラーの調査
- トーナメント作成時の認証エラーメ格の調査
- トークン生成ロジックと認証ロジックの不一致確認
- エラーメ格の改善

#### 1.3 Redis設定の確認
- 開発環境でのRedis接続確認
- 本番環境でのRedis設定の確認
- 開発環境での代用案（環境変数切り替え）

### フェーズ2：Redis実装

#### 2.1 rate limitingのRedis実装
- `@upstash/ratelimit`と`@upstash/redis`の正しい使用方法を確認
- Redis接続情報の環境変数化
- 本番環境でのRedis設定

#### 2.2 Redisでのフォールバック
- Redis接続失敗時のin-memory機能確認
- 本番環境でもフォールバックが動作するように設定

#### 2.3 Redis監視とログ
- Redis接続ステータスの監視
- レート制限のログ記録

#### 2.4 本番環境でのテスト
- Redis有効時のend-to-endテスト

### フェーズ3：認証エラー修正

#### 3.1 GitHub OAuth設定の修正
- AUTH環境変数の正しい設定
- GitHub OAuthアプリのClient Secret確認
- 認証エラーメ格の改善

#### 3.2 トークン生成ロジックの修正
- トークン生成と認証のタイミング修正
- 認証エラーの一貫性確認
- エラーハンドリングの改善

#### 3.3 認証シークレットの実装
- トークン有効期限の適切なチェック
- Refresh Token要求時の処理改善
- 401 Unauthorizedエラーの適切なハンドリング

### フェーズ4：テストとドキュメント

#### 4.1 Jest設定の修正
- ts-nodeの正しいバージョン確認と設定
- Jest設定ファイルの修正
- 基本テストの追加
- test scriptsの設定

#### 4.2 APIテストの追加
- 主要APIルートの単体テスト
- トークン関連機能のテスト
- rate limiting機能のテスト

#### 4.3 テストカバレッジの設定
- カバレッジ率（70%）以上を目標
- カバレッジ対象の明確定
- レポート出力の設定

### フェーズ5：リリース

#### 5.1 新機能実装（要求に応じて）
- キャラクター記録機能
- 使用キャラクター管理機能
- トーナメントプレビュー機能

#### 5.2 パフォーマンス改善
- Lighthouseスコア85以上を目標
- パフォーマンスの最適化
- モバイル時間の改善

---

## 技術的検討事項

### Redis実装について
- **Upstash Redis**: レート制限とキャッシュに最適
- **Cloudflare KV**: Vercel標準KV、追加コスト不要
- **自前Redis**: 開発環境でのみ使用

### テスト方針
- **Jest + React Testing Library**: モダーン表示のテスト
- **E2Eテスト**: APIの結合テスト
- **カバレッジ**: コードカバレッジの追跡

### セキュリティ考慮
- **本番環境監視**: Vercel Analytics + カスタム監視
- **アラート通知**: 重要なエラーや異常の即時通知
- **ログ集約**: 構造化ログによる分析効率化

---

## 優先度設定

### 高優先（即座実施）
- Redis実装によるレート制限の安定化
- GitHub Issuesの解決
- 認証エラーの修正

### 中優先（1-2週間）
- 基本テストの充実
- Redis監視とログ設定
- ドキュメント整備

### 低優先（1ヶ月以上）
- 新機能実装（要求に応じて）
- パフォーマンス改善
- キャラクター・統計機能

---

## 予想効果

### セキュリティ向上
- Redisベースのレート制限で安定動作
- 構造化された監査ログによる問題特定
- 認証シークレットによる不正アクセス防止

### 機能拡張
- Redisにより高度なキャッシュ戦略が可能に
- 監視データに基づいた改善施策が実行可能

### コスト最適化
- Upstash Redisの従量課金モデル
- Vercel無料枠での最適な運用
- スケーラビリティの向上

---

## 関連ツール

- **Vercel**: 本番デプロイ
- **Upstash**: Redis管理コンソール
- **GitHub**: Issue管理とバージョン管理
- **New Relic**: 監視とアラート（オプション）

---

## 成功基準

### 実装完了条件
- [ ] GitHub Issues 5件すべて解決
- [ ] 認証シークレット安定実装
- [ ] Redisベースレート制限
- [ ] 基本テスト導入
- [ ] Lighthouse 85+ スコア

### 品質確認
- [ ] ビルド成功
- [ ] デプロイ成功
- [ ] 本番環境での安定動作
- [ ] 貖用負荷への耐性
- [ ] セキュリティ要件の充足

---

## 担当者向けドキュメント

### Redis設定ガイド
- **開発環境**: `npm run dev:redis`でローカルRedis
- **本番環境**: 環境変数設定でUpstash Redisに接続
- **切り替え**: `REDIS_PROVIDER=upstash`または`REDIS_PROVIDER=local`で制御

### テスト実行コマンド
```bash
# 全テスト実行
npm run test

# Redis接続テスト
npm run test:redis

# カバレッジなしテスト
npm run test:no-cache
```

---

**担当者**: プロジェクトマネージャー
**開始日付**: 2026-01-19
**計画期間**: 1ヶ月（週次レビュー）