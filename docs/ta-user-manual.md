# タイムアタック ユーザーマニュアル

本マニュアルは、JSMKCシステムにおけるタイムアタック（Time Attack）モードの参加選手向けの操作ガイドです。

---

## 目次

1. [システム概要](#1-システム概要)
2. [予選ステージ](#2-予選ステージ)
3. [決勝ステージ](#3-決勝ステージ)
4. [タイム入力方法](#4-タイム入力方法)
5. [ランキングと順位](#5-ランキングと順位)
6. [ルールと注意事項](#6-ルールと注意事項)

---

## 1. システム概要

### 1.1 タイムアタックとは

タイムアタックは、スーパーマリオカートの全20コースを走り、合計タイムを競うモードです。

- **予選ステージ**: 全20コースのタイムを記録し、順位を決定
- **決勝ステージ**: 上位24名が進出し、3フェーズのトーナメント方式で優勝を争う

### 1.2 アクセス方法

#### URLの `[id]` について

マニュアル内のURLに含まれる `[id]` は、大会ごとの一意の識別番号です。

**アクセス方法:**

1. 大会主催者から共有されたURLを直接開く（推奨）
2. または、大会IDが分かっている場合、`[id]` を実際のIDに置き換えて入力

**例:**
- 大会IDが `123` の場合: `https://your-domain.com/tournaments/123/ta`

> **注意**: 大会IDは大会主催者より通知されます。自分でIDを決定することはできません。

| ページ | URL | 用途 |
|--------|-----|------|
| 予選・ランキング | `/tournaments/[id]/ta` | ランキング閲覧 |
| タイム入力 | `/tournaments/[id]/ta/participant` | タイムの入力・編集 |
| フェーズ1 | `/tournaments/[id]/ta/phase1` | 敗者復活戦1の観戦 |
| フェーズ2 | `/tournaments/[id]/ta/phase2` | 敗者復活戦2の観戦 |
| 決勝 | `/tournaments/[id]/ta/finals` | 決勝の観戦 |

### 1.3 ログイン

タイムを入力するにはログインが必要です。

- 大会主催者から発行されたアカウントでログインしてください
- ログイン状態はセッションで管理されます

---

## 2. 予選ステージ

### 2.1 予選の流れ

1. **タイム計測**: 全20コースを走行し、タイムを記録
2. **タイム入力**: システムにタイムを入力
3. **ランキング**: 順位が自動計算され、リアルタイムで表示
4. **予選完了**: 上位24名が決勝ステージへ進出

### 2.2 自己登録ページ

`/tournaments/[id]/ta/participant` からアクセスします。

#### 初回参加登録

まだタイムアタックに登録されていない場合：

1. `/tournaments/[id]/ta/participant` にアクセス
2. 「タイムアタックに参加する」ボタンが表示されます
3. ボタンをクリックして登録
4. 登録完了後、タイム入力フォームが表示されます

#### 機能

- **自分のタイム入力**: 20コースのタイムを入力
- **タイム編集**: いつでも修正可能（予選ステージがフリーズされるまで）
- **順位確認**: 現在の順位と総合タイムを表示
- **部分入力**: 全コース入力しなくても保存可能

### 2.3 ランキングページ

`/tournaments/[id]/ta` からアクセスします。

#### 表示内容

| セクション | 内容 |
|-----------|------|
| ランキング | 全選手の総合順位と合計タイム |
| タイム一覧 | コース別の全選手タイム |
| コースランキング | 各コースの上位タイム（アコーディオン形式で展開） |

---

## 3. 決勝ステージ

### 3.1 決勝ステージの構造

予選上位24名が決勝ステージへ進出します。

| フェーズ | 名称 | 参加者 | 形式 |
|---------|------|--------|------|
| フェーズ1 | 敗者復活戦1 | 予選17-24位（8名） | 1コース最下位敗退 |
| フェーズ2 | 敗者復活戦2 | フェーズ1勝者 + 予選13-16位 | 1コース最下位敗退 |
| フェーズ3 | 決勝 | フェーズ2勝者 + 予選1-12位（16名） | ライフ方式 |

### 3.2 観戦方法

決勝ステージは以下のページで観戦できます：

- **フェーズ1**: `/tournaments/[id]/ta/phase1`
- **フェーズ2**: `/tournaments/[id]/ta/phase2`
- **決勝**: `/tournaments/[id]/ta/finals`

#### 表示内容

- 現在のラウンド情報（コース名）
- 参加者のリストと状態
- ライブタイムの表示（更新時）
- 敗退状況
- 決勝ではライフ数の表示

### 3.3 リアルタイム更新

- ページは自動的に更新されます（3秒間隔）
- 新しいタブで開いても、キャッシュにより即座に最新情報が表示されます

---

## 4. タイム入力方法

### 4.1 タイム形式

タイムは `M:SS.mmm` 形式で入力してください。

| 正しい例 | 誤った例 |
|---------|----------|
| `1:23.456` | `1:23.45` |
| `0:45.000` | `83.456` |
| `2:59.990` | `1:23` |
| `0:30.001` | `30.1` |

### 4.2 入力手順

1. ログイン状態で `/tournaments/[id]/ta/participant` にアクセス
2. 20コースの入力フォームが表示されます
3. 各コースのタイムを入力
4. 「保存」ボタンをクリック
5. 保存され、順位が更新されます

### 4.3 部分入力

全コース入力しなくても保存できます。

- 途中までのタイムを保存して後で続きを入力可能
- 未入力のコースは最下位タイムとして扱われます
- **正確な順位を確認するには、全20コースの入力が必要です**

> **注意**: 部分入力の段階では表示される順位は暫定です。全コース入力完了後に正式な予選順位が確定します。

### 4.4 編集権限

- **ログイン選手**: 自分のタイムのみ編集可能
- **他の選手**: 「タイムを見る」ボタンで閲覧のみ
- **フリーズ後**: 予選ステージがフリーズされると、全選手の編集が不可になります

タイムの修正は、予選フリーズまでいつでも可能です。同じコースのタイムを上書きして更新できます。

---

## 5. ランキングと順位

### 5.1 予選順位の決定

予選順位は以下のルールで決まります：

1. **合計ポイント**: 全20コースのポイント合計（小数点以下切り捨て）
2. **合計タイム**: ポイントが同点の場合、合計タイムで比較

#### ポイント計算

各コースで最速タイムを記録した選手が50ポイントを獲得し、最も遅いタイムの選手が0ポイントを獲得します。有効参加者数（そのコースでタイムを記録した選手数）に応じてポイントが線形補間されます。

**計算式:**
```
各コースのポイント = 50 × (有効参加者数 - 順位) / (有効参加者数 - 1)
```

> **タイ処理**: 同タイムの選手は同じ順位とみなされ、該当順位のスコアを平均して共有します。

**例：11人が参加した場合**

| 順位 | ポイント |
|------|----------|
| 1位 | 50 |
| 2位 | 45 |
| 3位 | 40 |
| ... | ... |
| 11位 | 0 |

### 5.2 決勝進出

- 上位24名が決勝ステージへ進出
- 1-12位: 決勝（フェーズ3）シード
- 13-16位: フェーズ2シード
- 17-24位: フェーズ1からスタート

### 5.3 決勝の勝敗

| フェーズ | 勝利条件 |
|---------|----------|
| フェーズ1 | 各ラウンドの最下位以外が勝ち残る |
| フェーズ2 | 各ラウンドの最下位以外が勝ち残る |
| フェーズ3 | ライフを失わず最後まで残った選手が優勝 |

---

## 6. ルールと注意事項

### 6.1 基本ルール

- 1コースにつき1回のみの実施
- ポーズやリトライは禁止（リトライ時は9:59.990のペナルティ）
- ゴーストやCPU対戦相手が表示されている間は走行禁止
- ラップスキップ（ゴール付近でのバグによるショートカット）は禁止

### 6.2 予選ステージの注意事項

- **ペア走行について**: 大会ルールにより、2人1組でペアを組む場合があります。ペア走行の詳細は大会主催者の指示に従ってください。
- 予選ステージ中は練習を控えてください
- 全20コースを順番に走行してください

### 6.3 決勝ステージの注意事項

- 各フェーズ開始時にテレビが割り当てられます
- 試合開始後は、休憩の合間までテレビの前にいてください
- ランダムに選択されたコースで競技を行います
- 20コースすべてが選択されるまで同じコースはありません
- 各フェーズ間に5〜10分の休憩があります

### 6.4 システム使用上の注意

| 注意点 | 説明 |
|--------|------|
| フリーズ期間 | 予選完了後、ステージがフリーズされ、編集できなくなります |
| 自動更新 | ページは3秒間隔で自動更新されます |
| タイム形式 | 必ず `M:SS.mmm` 形式で入力してください |
| ログイン | タイム入力にはログインが必要です |

---

## 7. よくある質問

### Q1: タイムを間違えて入力してしまった場合

A: 予選ステージがフリーズされるまでであれば、いつでも修正可能です。もう一度正しいタイムを入力して保存してください。

### Q2: 途中までしかタイムを入力できない

A: 部分入力が可能です。入力できたコースを保存して、後で続きを入力してください。

### Q3: ランキングが正しく表示されない

A: ページを更新してください。自動更新も行われていますが、手動で更新することも可能です。

### Q4: 決勝に進出できるか

A: 予選上位24名が決勝へ進出できます。自分の順位はランキングページで確認してください。

### Q5: 決勝のルールが複雑で分からない

A: 決勝は3つのフェーズで構成されています。予選順位に応じて、異なるフェーズからスタートします。観戦ページで状況を確認してください。

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| 予選ステージ | 全20コースを走り、順位を決定するステージ |
| 決勝ステージ | 上位24名によるトーナメント方式のステージ |
| フェーズ | 決勝内のラウンド区分（Phase 1/2/3） |
| ラウンド | 各コースの競技単位 |
| ライフ | フェーズ3での残機システム（ハートで表示） |
| ペナルティ | リトライ時に課せられる9:59.990のタイム |
| フリーズ | ステージをロックし、編集を禁止する状態 |
| シード | 上位選手が後のフェーズからスタートできること |

---

## 改訂履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 1.0 | 2026-02-07 | 初版作成 |
| 1.1 | 2026-02-08 | URLパス修正（revival→phase）、ポイント計算詳細化、ポーリング間隔修正、編集権限・初回登録手順追記 |
