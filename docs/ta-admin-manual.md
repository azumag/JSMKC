# タイムアタック 管理者マニュアル

本マニュアルは、JSMKCシステムにおけるタイムアタック（Time Attack）モードの運用管理者向けの操作ガイドです。

---

## 目次

1. [システム概要](#1-システム概要)
2. [予選ステージの運用](#2-予選ステージの運用)
3. [決勝ステージの運用](#3-決勝ステージの運用)
4. [フェーズ管理](#4-フェーズ管理)
5. [ラウンド運用](#5-ラウンド運用)
6. [データエクスポート](#6-データエクスポート)
7. [トラブルシューティング](#7-トラブルシューティング)

---

## 1. システム概要

### 1.1 画面構成

| 画面 | パス | 用途 |
|------|------|------|
| 予選メイン | `/tournaments/[id]/ta` | 予選ステージの管理 |
| 選手登録 | `/tournaments/[id]/ta/participant` | 選手による自己登録 |
| フェーズ1 | `/tournaments/[id]/ta/phase1` | 敗者復活戦1 |
| フェーズ2 | `/tournaments/[id]/ta/phase2` | 敗者復活戦2 |
| フェーズ3（決勝） | `/tournaments/[id]/ta/finals` | ライフ方式決勝 |

### 1.2 管理者権限

以下の機能は管理者のみが実行可能です：

- 選手の追加・削除
- 全選手のタイム編集
- ステージの凍結/解除（予選・各フェーズ）
- フェーズの進行管理（昇格操作）
- ラウンドの開始/キャンセル
- 手動敗退処理（決勝フェーズ3のみ）

**選手の編集権限:**
- ログイン済みの選手は、自分自身のタイムのみ編集可能です
- フリーズ中は管理者・選手ともに編集できません

**権限の付与について:**
- 管理者権限は大会主催者によって付与されます
- 画面上の制御はUX向上のためのクライアント側チェックです
- 実際の権限はサーバー側で厳格に管理されています

---

## 2. 予選ステージの運用

### 2.1 予選ページのレイアウト

予選ページ（`/tournaments/[id]/ta`）には以下のセクションが表示されます：

1. **ランキングセクション**: 全選手の総合順位
2. **タイム一覧セクション**: コース別の全選手タイム
3. **コースランキングセクション**: コースごとの上位タイム
4. **フェーズ管理カード**: 各フェーズの状況表示
5. **管理コントロール**: 管理者用の操作ボタン

### 2.2 選手の追加

#### バルク追加手順

1. 画面上部の「追加」ボタンをクリック
2. 選手一覧ダイアログが表示される
3. 検索ボックスで選手名を入力して絞り込み
4. 追加する選手にチェックを入れる（複数選択可能）
5. 「追加」ボタンをクリック

> **注意**: 追加された選手の全20コースのタイムは初期状態で空です。

#### 自己登録の利用

選手には `/tournaments/[id]/ta/participant` から自己登録も可能です。

- 選手はログイン後に自動的に識別されます
- 自分のタイムのみ入力・編集可能
- 部分入力（途中までのタイム）も可能

### 2.3 タイムの入力・編集

#### 編集権限

| ユーザー | 編集範囲 | 条件 |
|---------|---------|------|
| 管理者 | 全選手のタイム | フリーズされていないステージのみ |
| ログイン選手 | 自分のタイムのみ | フリーズされていないステージのみ |
| 未ログイン | 閲覧のみ | - |

> **注意**: ログイン選手は予選ページ（`/tournaments/[id]/ta`）の「タイム入力」タブから自分のエントリの「編集」ボタンで直接タイム編集が可能です。他の選手のタイムは「タイムを見る」ボタンで閲覧のみです。

#### 管理者によるタイム入力

1. 対象選手の行にある「編集」ボタンをクリック
2. 20コースのタイム入力ダイアログが表示される
3. 各コースのタイムを `M:SS.mmm` 形式で入力
4. 「保存」ボタンをクリック

#### タイム形式

| 正しい形式 | 誤った形式 |
|-----------|-----------|
| `1:23.456` | `1:23.45` |
| `0:45.000` | `83.456` |
| `2:59.990` | `1:23` |

> **ルール**: 空欄は許可されます（部分入力対応）。ミリ秒は3桁で揃えてください。

### 2.4 選手の削除

1. 対象選手の行にある「削除」ボタンをクリック
2. 確認ダイアログで「削除」を確認

> **警告**: 削除は元に戻せません。慎重に実行してください。

### 2.5 ステージの凍結（フリーズ）

予選ステージを完了したら、ステージを凍結して誤編集を防ぎます。

#### フリーズ手順

1. 画面上部の「フリーズ」ボタンをクリック
2. 即座にフリーズが実行され、トースト通知が表示されます

#### フリーズ解除

1. 「フリーズ解除」ボタンをクリック
2. 即座に解除が実行され、トースト通知が表示されます

> **警告**: フリーズ/解除には確認ダイアログが表示されません。ボタンクリックで即座に実行されるため、誤操作に注意してください。

> **注意**: フリーズ中は管理者も選手も編集できません。解除する必要があります。

#### フェーズごとのフリーズ

各決勝フェーズ（Phase 1/2/3）にも個別のフリーズ/解除ボタンがあります。フェーズが開始された後に表示されます。フリーズバッジがフェーズ名の横に表示されます。

---

## 3. 決勝ステージの運用

### 3.1 決勝ステージの構造

決勝ステージは3つのフェーズで構成されます：

| フェーズ | 名称 | 参加者 | 形式 | 生存者 |
|---------|------|--------|------|--------|
| フェーズ1 | 敗者復活戦1 | 予選17-24位（8名） | 1コース最下位敗退 | 4名 |
| フェーズ2 | 敗者復活戦2 | フェーズ1勝者（4）+ 予選13-16位（4） | 1コース最下位敗退 | 4名 |
| フェーズ3 | 決勝 | フェーズ2勝者（4）+ 予選1-12位（12） | ライフ方式 | 1名 |

### 3.2 予選完了の確認

予選ステージ完了後、以下を確認してください：

1. 全選手のタイムが入力されている
2. 順位が正しく計算されている
3. 予選ステージをフリーズしている

#### 予選順位の決定方法

予選順位は以下のルールで決まります：

1. **合計ポイント（qualificationPoints）**: 全20コースのポイント合計（小数点以下切り捨て）が高い順
2. **合計タイム**: ポイントが同点の場合、全20コースの合計タイムが速い方が上位

**ポイント計算式:**
```
各コースのポイント = 50 × (有効参加者数 - 順位) / (有効参加者数 - 1)
```

- 各コースで最速が50ポイント、最遅が0ポイント
- 有効参加者数: そのコースでタイムを記録した選手数
- 同タイムの選手: スコアを平均して共有（タイ処理）
- 全20コースの合計は `Math.floor()` で切り捨て

**例：11人が参加した場合**
- 1位: 50ポイント、2位: 45ポイント、3位: 40ポイント、...、11位: 0ポイント

---

## 4. フェーズ管理

### 4.1 フェーズ管理カード

予選ページには各フェーズの状況カードが表示されます：

| 表示項目 | 説明 |
|---------|------|
| フェーズ名 | Phase 1 / Phase 2 / Finals |
| ステータス | Not Started / In Progress / Completed |
| 参加者数 | 現在の参加者数 |
| 敗退者数 | 敗退した選手数 |

### 4.2 フェーズの開始

#### フェーズ1の開始

1. 予選完了後、「フェーズ1を開始」ボタンをクリック
2. 予選17-24位の選手が自動的にフェーズ1に登録されます

#### フェーズ2の開始

1. フェーズ1完了後、「フェーズ2を開始」ボタンをクリック
2. フェーズ1の勝者（4名）+ 予選13-16位（4名）が自動的に登録されます

#### 決勝（フェーズ3）の開始

1. フェーズ2完了後、「決勝を開始」ボタンをクリック
2. フェーズ2の勝者（4名）+ 予選1-12位（12名）が自動的に登録されます

### 4.3 フェーズスキップ

対象参加者がいないフェーズは「スキップ」として表示され、昇格ボタンが表示されません：

- 例：予選17-24位の選手がいない場合、フェーズ1は「スキップ」と表示され、フェーズ2から開始できます

---

## 5. ラウンド運用

### 5.1 フェーズ1・2のラウンド運用

フェーズ1・2は `/tournaments/[id]/ta/phase1` および `/tournaments/[id]/ta/phase2` で管理します。

#### ラウンドの開始

1. 「ラウンド開始」ボタンをクリック
2. システムがランダムにコースを選択
3. 全20コース使用済みの場合、プールがリセットされます

> **重要**: コース選択はサーバーサイドで行われ、バイアスはありません。

#### タイムの入力

1. 全参加者のタイムを入力フォームに入力
2. 「結果を提出」ボタンをクリック
3. 最下位の選手が自動的に敗退します

#### リトライの処理

選手がリトライした場合：

1. 該当選手の「リトライ」ボタンをクリック
2. タイムが自動的に `9:59.990` に設定される（入力フィールドが無効化される）
3. もう一度「リトライ」ボタンをクリックすると解除可能
4. 結果提出時にリトライフラグ付きで処理されます

#### ラウンドのキャンセル

1. 「ラウンドキャンセル」ボタンをクリック
2. 確認ダイアログが表示される
3. 「キャンセル確定」をクリック
4. コースがプールに戻されます
5. タイムは破棄されます

> **注意**: 結果提出後はキャンセルできません。
>
> **警告**: 誤ってタイムを入力して結果を提出してしまった場合、元に戻すことはできません。必ず提出前に全選手のタイムを確認してください。

### 5.2 フェーズ3（決勝）のラウンド運用

フェーズ3は `/tournaments/[id]/ta/finals` で管理します。

#### ライフシステム

- 各選手は3つのライフ（ハートで表示）から開始
- 下位半分の選手が1ライフを失う
- ライフが0になった選手は敗退

**下位半分の計算:**
- 上位（セーフ）人数 = `Math.ceil(参加者数 / 2)` 名
- 残りの選手がライフ-1
- 16名 → 上位8名セーフ、下位8名がライフ-1
- 15名 → 上位8名セーフ、下位7名がライフ-1
- 7名 → 上位4名セーフ、下位3名がライフ-1

#### ライフのリセット

残存選手数が以下の数字になった時、全選手のライフが3にリセットされます：

- 8名に到達時
- 4名に到達時
- 2名に到達時

> **重要**: ライフリセットは「そのラウンドで実際に敗退が発生した場合のみ」トリガーされます。敗退なしで残存数が閾値と一致しても、リセットは発動しません。

リセット時にバナー通知が表示されます。

#### タイム入力と結果提出

1. 全参加者のタイムを入力
2. 「結果を提出」ボタンをクリック
3. 下位半分のライフが1つ減り、0になった選手が敗退

#### 手動敗退

選手を手動で敗退させる必要がある場合：

1. 対象選手の「敗退」ボタンをクリック
2. 確認ダイアログで「敗退」を確認

#### チャンピオン決定

最後の1名が残ると：

- トロフィーのアイコンが表示されます
- チャンピオンとしてマークされます

---

## 6. データエクスポート

### 6.1 エクスポート機能

予選ページからデータをエクスポートできます：

1. 「エクスポート」ボタンをクリック
2. Excelファイル(.xlsx)が自動的にダウンロードされます

### 6.2 エクスポート内容

エクスポートファイルには以下の列が含まれます：

| 列名 | 内容 |
|------|------|
| Rank | 予選順位 |
| Player Name | 選手名 |
| Nickname | ニックネーム |
| Total Time (ms) | 合計タイム（ミリ秒） |
| Total Time | 合計タイム（表示形式） |
| Lives | 残りライフ数 |
| Eliminated | 敗退状態（Yes/No） |

> **注意**: ファイル形式はCSV（UTF-8 BOM付き）です。Excelで直接開くことができます。

---

## 7. トラブルシューティング

### 7.1 タイム入力の問題

| 問題 | 解決策 |
|------|--------|
| タイムが保存されない | 形式が `M:SS.mmm` であることを確認 |
| 順位が正しくない | 全選手のタイムが入力されているか確認 |
| 同タイムで順位が決まらない | 合計タイムが速い選手が上位（タイブレイク規定） |
| 編集できない | ステージがフリーズされていないか確認 |

### 7.2 フェーズ進行の問題

| 問題 | 解決策 |
|------|--------|
| フェーズ開始ボタンが表示されない | 前のフェーズが完了しているか確認 |
| 参加者が正しくない | 予選の順位が正しいか確認 |
| ラウンド開始できない | 前のラウンドが完了しているか確認 |

### 7.3 ラウンド運用の問題

| 問題 | 解決策 |
|------|--------|
| コースが重複している | ラウンドをキャンセルして再開 |
| 敗退処理が正しくない | 手動敗退機能を使用 |
| ライフがリセットされない | 残存選手数が閾値（8/4/2）になっているか確認 |

### 7.4 開発者ツール（開発環境のみ）

開発環境では以下のツールが利用可能です：

- **ランダムタイム充填**: テスト用のランダムタイムを生成
- **全選手充填**: 全選手にランダムタイムを一括入力

> **警告**: これらは `process.env.NODE_ENV === 'development'` の時のみ表示されます。
>
> **重要**: 本番環境では絶対に使用しないでください。テストデータが本番データに混入し、大会結果に重大な影響を与える可能性があります。

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| ステージ | 予選・決勝の区分 |
| フェーズ | 決勝内のラウンド区分（Phase 1/2/3） |
| ラウンド | 各コースの競技単位 |
| ライフ | フェーズ3での残機システム（ハートで表示） |
| フリーズ | ステージをロックし、編集を禁止する機能 |
| 敗退 | 選手が競技から脱落すること |
| リトライ | 選手がコースをやり直すこと（ペナルティあり） |

---

## 改訂履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 1.0 | 2026-02-07 | 初版作成 |
| 1.1 | 2026-02-08 | URLパス修正（revival→phase）、ポイント計算詳細化、ライフ計算精緻化、フリーズ機能・編集権限追記 |
| 1.2 | 2026-02-08 | エクスポート形式詳細追記（CSV列情報・Excel互換性）、フリーズ確認ダイアログ記述修正 |
| 1.3 | 2026-02-08 | フェーズスキップ説明修正、手動敗退処理のスコープ明記（Phase3のみ） |
