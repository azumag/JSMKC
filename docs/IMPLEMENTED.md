# JSMKC ãƒ¬ãƒ“ãƒ¥ãƒ¼é‡å¤§å•é¡Œä¿®æ­£å®Ÿæ–½å ±å‘Š

å®Ÿæ–½æ—¥: 2026-01-19

## ä¿®æ­£æ¦‚è¦

ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰æŒ‡æ‘˜ã•ã‚ŒãŸ**é‡å¤§å•é¡Œ3ä»¶**ã‚’ã™ã¹ã¦ä¿®æ­£ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æœ¬ç•ªç’°å¢ƒã§ã®å®‰å…¨ãªé‹ç”¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã—ãŸã€‚

---

## ä¿®æ­£å®Œäº†ã—ãŸé‡å¤§å•é¡Œï¼ˆ3ä»¶ï¼‰

### 1. GitHub OAuth Refresh Tokenæ©Ÿèƒ½ä¿®æ­£ã€CR-001ã€‘âœ…

**å•é¡Œ**: GitHubãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ã®refresh tokenå‡¦ç†ãŒæ¬ è½ã—ã€1æ™‚é–“å¾Œã«å†èªè¨¼ãŒå¿…è¦
**ä¿®æ­£å†…å®¹**:
- `refreshGitHubAccessToken`é–¢æ•°ã‚’å®Ÿè£…
- JWT callbackã§GitHubãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚‚refresh tokenå‡¦ç†ã‚’å‘¼ã³å‡ºã—
- Googleã¨GitHubä¸¡æ–¹ã§çµ±ä¸€ã•ã‚ŒãŸrefresh tokenãƒ•ãƒ­ãƒ¼

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `jsmkc-app/src/lib/auth.ts` - GitHub refresh tokenå®Ÿè£…ã¨callbackä¿®æ­£

**åŠ¹æžœ**: GitHub/Googleä¸¡æ–¹ã®OAuthã§24æ™‚é–“refresh tokenãŒæ©Ÿèƒ½ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š

### 2. ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ä¿®æ­£ - In-Memory Rate Limitingã€CR-002ã€‘âœ…

**å•é¡Œ**: in-memory rate limiting storeã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒä¸å®Œå…¨ã§é•·æ™‚é–“é‹ç”¨ã§ãƒ¡ãƒ¢ãƒªå¢—åŠ 
**ä¿®æ­£å†…å®¹**:
- å®šæœŸçš„ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚’å®Ÿè£…ï¼ˆ5åˆ†é–“éš”ï¼‰
- `setInterval`ã«ã‚ˆã‚‹è‡ªå‹•expiredã‚¨ãƒ³ãƒˆãƒªå‰Šé™¤
- ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†

**å®Ÿè£…**:
```typescript
// å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
let cleanupInterval: NodeJS.Timeout | null = null

function startPeriodicCleanup() {
  cleanupInterval = setInterval(() => {
    const now = Date.now()
    for (const [key, value] of rateLimitStore.entries()) {
      if (value.resetTime < now) {
        rateLimitStore.delete(key)
      }
    }
  }, 5 * 60 * 1000) // 5åˆ†ã”ã¨
}
```

**åŠ¹æžœ**: é•·æ™‚é–“é‹ç”¨ã§ã®å®‰å®šæ€§ç¢ºä¿ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢

### 3. Nonceä¼æ’­å®Ÿè£…ã€CR-003ã€‘âœ…

**å•é¡Œ**: middlewareã§ç”Ÿæˆã—ãŸnonceãŒlayout.tsxã«ä¼æ’­ã›ãšã€CSPãŒä¸å®Œå…¨
**ä¿®æ­£å†…å®¹**:
- layout.tsxã§headersã‹ã‚‰`x-nonce`ã‚’å–å¾—
- å–å¾—ã—ãŸnonceã‚’CSP metaã‚¿ã‚°ã«è¨­å®š
- æœ¬ç•ªç’°å¢ƒãƒ»é–‹ç™ºç’°å¢ƒã§ã®é©åˆ‡ãªCSPè¨­å®š

**å®Ÿè£…**:
```typescript
// layout.tsx
const headersList = headers()
const nonce = headersList.get('x-nonce') || crypto.randomUUID()

// CSP meta tag with nonce
content={`script-src 'self' 'nonce-${nonce}' 'strict-dynamic' ...`}
```

**åŠ¹æžœ**: Architecture.mdä»•æ§˜ã®å®Œå…¨ãªCSPå®Ÿè£…ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

---

## ä¿®æ­£åŠ¹æžœ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- âœ… **Refresh Token**: GitHub/Googleä¸¡æ–¹ã§24æ™‚é–“refresh tokenæ©Ÿèƒ½
- âœ… **CSP Protection**: nonceã‚’ä½¿ç”¨ã—ãŸå®Œå…¨ãªCSPãƒãƒªã‚·ãƒ¼å®Ÿè£…
- âœ… **Memory Safety**: é•·æ™‚é–“é‹ç”¨ã§ã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š
- âœ… **Seamless Auth**: ã©ã¡ã‚‰ã®OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ã‚‚24æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒ
- âœ… **Performance**: ãƒ¡ãƒ¢ãƒªåŠ¹çŽ‡åŒ–ã«ã‚ˆã‚‹å®‰å®šã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é©åˆæ€§
- âœ… **å®Œå…¨æº–æ‹ **: Architecture.md section 6.2, 6.3ã®ä»•æ§˜ã‚’æº€ãŸã™
- âœ… **ä¸€è²«æ€§**: ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§çµ±ä¸€ã•ã‚ŒãŸtokenç®¡ç†

---

## æ®‹ã‚¿ã‚¹ã‚¯çŠ¶æ³

### ä¸»è¦å•é¡Œï¼ˆ5ä»¶ï¼‰
- **MJ-001**: APIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼çµ±ä¸€ - å¯¾å¿œäºˆå®š
- **MJ-002**: Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£… - å¯¾å¿œäºˆå®š  
- **MJ-003**: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è¿½åŠ  - å¯¾å¿œäºˆå®š
- **MJ-004**: ç’°å¢ƒå¤‰æ•°å‘½åçµ±ä¸€ - å¯¾å¿œäºˆå®š
- **MJ-005**: Audit Logãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£… - å¯¾å¿œäºˆå®š

### è»½å¾®å•é¡Œï¼ˆ4ä»¶ï¼‰
- **MN-001ï½žMN-004**: å®šæ•°æŠ½å‡ºã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„ãªã© - å¾Œæ—¥å¯¾å¿œäºˆå®š

---

## å‹•ä½œç¢ºèª

### ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
- âœ… `npm run build` - æˆåŠŸ
- âœ… `npm run lint` - æˆåŠŸ

### æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- âœ… GitHub OAuth refresh tokenå‹•ä½œ
- âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å®‰å®šæ€§
- âœ… CSP nonceä¼æ’­ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
- âœ… Refresh tokenæ©Ÿæ§‹å®Œå…¨å‹•ä½œ
- âœ… CSPãƒãƒªã‚·ãƒ¼é©åˆ‡ãªè¨­å®š
- âœ… ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢

---

## æ¬¡ã‚¹ãƒ†ãƒƒãƒ—

**é‡å¤§å•é¡Œ3ä»¶ã™ã¹ã¦ä¿®æ­£å®Œäº†** ðŸŽ‰

ã“ã‚Œã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¯èƒ½ã¨ãªã‚Šã¾ã—ãŸã€‚ä¸»è¦å•é¡Œ5ä»¶ã‚‚ä¿®æ­£ã™ã‚‹äºˆå®šã§ã™ãŒã€é‡å¤§å•é¡ŒãŒè§£æ±ºã—ãŸãŸã‚æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

æ¬¡ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ã—ã€å•é¡ŒãŒãªã‘ã‚Œã°QAã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸QAä¾é ¼ã‚’è¡Œã„ã¾ã™ã€‚